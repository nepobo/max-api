# AI Assistant Context for MAX Messenger API

This file provides context for AI coding assistants (GitHub Copilot, Cursor, etc.)

## Quick Reference

### ⚠️ CRITICAL: MAX API Message Sending
```python
# ✅ CORRECT - user_id in URL query parameter
response = requests.post(
    f"{base_url}/messages?user_id={chat_id}",
    headers={"Authorization": token},
    json={"text": "Hello"}
)

# ❌ WRONG - don't put user_id in body
response = requests.post(
    f"{base_url}/messages",
    json={"recipient": {"chat_id": chat_id}, "text": "Hello"}  # WRONG!
)
```

### ⚠️ CRITICAL: Getting chat_id for Reply
```python
# ✅ CORRECT - use sender.user_id
chat_id = message['sender']['user_id']

# ❌ WRONG - don't use recipient
chat_id = message['recipient']['chat_id']  # WRONG!
```

### ⚠️ CRITICAL: Long Polling Timeout is Normal
```python
# ✅ CORRECT - handle timeout gracefully
try:
    updates = client.get_updates(timeout=30)
except Exception as e:
    if "timeout" in str(e).lower():
        continue  # This is NORMAL, not an error!
```

## Project Structure
```
max-api/
├── max_api/              # Main library
│   ├── client.py        # MAXClient class
│   ├── exceptions.py    # API exceptions
│   └── utils.py         # Utilities (RateLimiter, etc)
├── examples/            # Bot examples
│   ├── echo_bot.py
│   ├── simple_bot.py
│   └── get_chat_id_bot.py
├── console_app/         # CLI application
└── tests/               # pytest tests
```

## MAXClient Quick API

```python
from max_api import MAXClient

client = MAXClient(token=os.getenv('MAX_BOT_TOKEN'))

# Get bot info
info = client.get_me()

# Send message (chat_id = user_id!)
client.send_message(chat_id=user_id, text="Hi", format="markdown")

# Get updates (Long Polling)
updates = client.get_updates(timeout=30, marker=last_marker)

# Webhook (production)
client.create_subscription(url="https://example.com/webhook")
```

## Common Patterns

### Bot Main Loop
```python
last_marker = None
while True:
    try:
        updates = client.get_updates(timeout=30, marker=last_marker)
    except Exception as e:
        if "timeout" in str(e).lower():
            continue  # Normal - no messages received
        print(f"Error: {e}")
        time.sleep(5)
        continue
    
    for update in updates:
        if update.get('update_type') == 'message_created':
            message = update['message']
            chat_id = message['sender']['user_id']  # Important!
            text = message.get('body', {}).get('text', '')
            
            # Process message
            client.send_message(chat_id=chat_id, text="Reply")
        
        if 'marker' in update:
            last_marker = update['marker']
```

### Error Handling
```python
from max_api.exceptions import RateLimitError, MAXAPIException

try:
    client.send_message(chat_id=123, text="Hi")
except RateLimitError:
    time.sleep(60)  # Wait on rate limit
except MAXAPIException as e:
    print(f"API error: {e}")
```

## Environment Setup

```bash
# Linux - always use venv
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# .env file
echo "MAX_BOT_TOKEN=your_token" > .env
```

## MAX API Reference

- **Base**: https://platform-api.max.ru
- **Rate**: 30 RPS (handled by RateLimiter)
- **Auth**: `Authorization: {token}` header (NO Bearer prefix)
- **Timeout**: 30 seconds for Long Polling (normal!)

### Endpoints
- GET `/me` - bot info
- POST `/messages?user_id={id}` - send message
- GET `/updates?timeout={sec}&marker={marker}` - get updates
- POST `/subscriptions` - create webhook

## Documentation Files

- `README.md` - main documentation
- `ALL_FIXES.md` - all bug fixes
- `LONG_POLLING_TIMEOUT.md` - timeout explanation
- `HOW_TO_CONNECT_BOT.md` - bot connection guide
- `.cursorrules` - detailed rules for Cursor AI
- `.github/copilot-instructions.md` - GitHub Copilot guide

## Key Points

1. **user_id in URL query** when sending messages
2. **chat_id = sender.user_id** for replies
3. **Timeout is normal** in Long Polling
4. **Use venv** on Linux
5. **30 RPS limit** enforced by RateLimiter
6. **No Bearer prefix** in Authorization header

For full details, see `.cursorrules` or `ALL_FIXES.md`.

# План разработки приложения для работы с мессенджером MAX

## Обзор проекта
Разработка Python библиотеки и консольного приложения для взаимодействия с мессенджером MAX через его API. Приложение позволяет отправлять и получать сообщения через механизм чат-бота.

## Дата начала: 25 февраля 2026

---

## Этап 1: Подготовка и изучение API (1 день)

### 1.1 Анализ документации
- [x] Изучение API документации MAX (https://dev.max.ru/docs-api)
- [x] Изучение механизма работы с чат-ботами (https://dev.max.ru/docs/chatbots/bots-coding/prepare)
- [ ] Определение необходимых методов API для реализации

### 1.2 Основные выводы из документации:
- **Базовый URL API**: `https://platform-api.max.ru`
- **Аутентификация**: через заголовок `Authorization: <token>`
- **Лимит запросов**: 30 RPS (requests per second)
- **Форматы**: JSON для всех запросов/ответов
- **Получение обновлений**: 
  - Long Polling (для разработки/тестирования) - GET `/updates`
  - Webhook (для production) - POST `/subscriptions`
- **HTTP методы**: GET, POST, PUT, DELETE, PATCH

### 1.3 Ключевые методы API:
- `GET /me` - информация о боте
- `POST /messages` - отправка сообщений
- `GET /messages/{messageId}` - получение сообщения
- `GET /updates` - получение обновлений (Long Polling)
- `POST /subscriptions` - настройка Webhook
- `GET /subscriptions` - получение настроек уведомлений

---

## Этап 2: Структура проекта (0.5 дня)

### 2.1 Создание структуры директорий
```
max-api/
├── max_api/                    # Основной пакет библиотеки
│   ├── __init__.py
│   ├── client.py              # Основной клиент API
│   ├── methods/               # Методы API
│   │   ├── __init__.py
│   │   ├── messages.py        # Работа с сообщениями
│   │   ├── updates.py         # Получение обновлений
│   │   └── subscriptions.py   # Управление подписками
│   ├── models/                # Модели данных
│   │   ├── __init__.py
│   │   ├── message.py
│   │   ├── user.py
│   │   ├── chat.py
│   │   └── update.py
│   ├── exceptions.py          # Пользовательские исключения
│   └── utils.py               # Утилиты
├── examples/                   # Примеры использования
│   ├── simple_bot.py
│   └── echo_bot.py
├── console_app/               # Консольное приложение
│   ├── __init__.py
│   ├── main.py               # Точка входа
│   ├── config.py             # Конфигурация
│   └── commands.py           # Команды консоли
├── tests/                     # Тесты
│   ├── __init__.py
│   ├── test_client.py
│   └── test_methods.py
├── .env.example              # Пример конфигурации
├── .gitignore
├── requirements.txt          # Зависимости
├── setup.py                  # Установка пакета
├── README.md                 # Документация
└── DEVELOPMENT_PLAN.md       # Этот файл
```

### 2.2 Технологический стек
- **Python**: 3.8+
- **Библиотеки**:
  - `requests` - HTTP запросы
  - `python-dotenv` - работа с переменными окружения
  - `pydantic` - валидация данных (опционально)
  - `click` или `argparse` - CLI интерфейс
  - `colorama` - цветной вывод в консоль
  - `pytest` - тестирование

---

## Этап 3: Разработка базовой библиотеки (2-3 дня)

### 3.1 Создание базового клиента (`client.py`)
- [ ] Класс `MAXClient` для работы с API
- [ ] Методы для выполнения HTTP запросов (GET, POST, PUT, DELETE, PATCH)
- [ ] Обработка ошибок и кодов ответа HTTP (200, 400, 401, 404, 429, 503)
- [ ] Управление токеном аутентификации
- [ ] Реализация rate limiting (30 RPS)

**Основные методы класса**:
```python
class MAXClient:
    def __init__(self, token: str, base_url: str = "https://platform-api.max.ru")
    def _request(self, method: str, endpoint: str, **kwargs) -> dict
    def get_me(self) -> dict  # GET /me
```

### 3.2 Модели данных (`models/`)
- [ ] `Message` - представление сообщения
- [ ] `User` - представление пользователя
- [ ] `Chat` - представление чата
- [ ] `Update` - представление обновления (входящие события)
- [ ] `Attachment` - вложения (inline_keyboard, файлы и т.д.)

### 3.3 Методы работы с сообщениями (`methods/messages.py`)
- [ ] `send_message(chat_id, text, attachments=None)` - отправка сообщения
- [ ] `get_message(message_id)` - получение сообщения по ID
- [ ] Поддержка форматирования текста (Markdown, HTML)
- [ ] Поддержка inline-клавиатуры

### 3.4 Методы получения обновлений (`methods/updates.py`)
- [ ] `get_updates(limit=None, timeout=30, marker=None)` - Long Polling
- [ ] Обработка различных типов обновлений:
  - `message_created` - новое сообщение
  - `message_callback` - нажатие на inline-кнопку
  - `bot_started` - запуск бота через deeplink
  - `message_edited` - редактирование сообщения
  - `message_removed` - удаление сообщения

### 3.5 Методы управления подписками (`methods/subscriptions.py`)
- [ ] `create_subscription(url, update_types=None)` - создание Webhook
- [ ] `get_subscriptions()` - получение активных подписок
- [ ] `delete_subscription(url)` - удаление подписки

### 3.6 Обработка исключений (`exceptions.py`)
- [ ] `MAXAPIException` - базовое исключение
- [ ] `AuthenticationError` - ошибка аутентификации (401)
- [ ] `BadRequestError` - неверный запрос (400)
- [ ] `NotFoundError` - ресурс не найден (404)
- [ ] `RateLimitError` - превышен лимит запросов (429)
- [ ] `ServiceUnavailableError` - сервис недоступен (503)

---

## Этап 4: Консольное приложение (2 дня)

### 4.1 Основной функционал (`console_app/main.py`)
- [ ] Интерактивный режим работы
- [ ] Авторизация по токену (из переменной окружения или ввод)
- [ ] Меню с командами:
  - Отправить сообщение
  - Просмотреть входящие сообщения
  - Запустить прослушивание (Long Polling)
  - Выход

### 4.2 Конфигурация (`console_app/config.py`)
- [ ] Загрузка токена из `.env` файла
- [ ] Настройки приложения (интервал опроса, лимиты и т.д.)

### 4.3 Команды (`console_app/commands.py`)
- [ ] `send_message_cmd()` - отправка сообщения в чат
- [ ] `listen_messages_cmd()` - прослушивание входящих сообщений
- [ ] `list_chats_cmd()` - список активных чатов
- [ ] `bot_info_cmd()` - информация о боте

### 4.4 Интерфейс пользователя
- [ ] Цветной вывод для разных типов событий
- [ ] Форматирование входящих/исходящих сообщений
- [ ] Отображение информации об отправителе
- [ ] Индикация состояния подключения

---

## Этап 5: Примеры и документация (1 день)

### 5.1 Примеры использования (`examples/`)
- [ ] `simple_bot.py` - простой бот, отвечающий на сообщения
- [ ] `echo_bot.py` - эхо-бот, повторяющий сообщения пользователя
- [ ] Пример с inline-клавиатурой
- [ ] Пример обработки callback-событий

### 5.2 Документация
- [ ] README.md с инструкциями по установке и использованию
- [ ] Документирование API библиотеки (docstrings)
- [ ] Примеры использования в README
- [ ] Описание переменных окружения

---

## Этап 6: Тестирование (1-2 дня)

### 6.1 Unit тесты
- [ ] Тесты для `MAXClient`
- [ ] Тесты для моделей данных
- [ ] Тесты для методов API (с mock-объектами)
- [ ] Тесты обработки ошибок

### 6.2 Интеграционное тестирование
- [ ] Тесты реальных запросов к API (при наличии тестового токена)
- [ ] Тесты Long Polling
- [ ] Тесты отправки/получения сообщений

---

## Этап 7: Финализация (0.5 дня)

### 7.1 Подготовка к релизу
- [ ] Проверка всей функциональности
- [ ] Исправление найденных багов
- [ ] Оптимизация кода
- [ ] Обновление документации

### 7.2 Дополнительные файлы
- [ ] `.gitignore` - исключения для git
- [ ] `requirements.txt` - список зависимостей
- [ ] `setup.py` - установка пакета через pip
- [ ] `.env.example` - пример конфигурации
- [ ] LICENSE - лицензия проекта

---

## Основные функции библиотеки MAX API

### Класс MAXClient
```python
from max_api import MAXClient

# Инициализация клиента
client = MAXClient(token="YOUR_BOT_TOKEN")

# Получение информации о боте
bot_info = client.get_me()

# Отправка сообщения
message = client.send_message(
    chat_id=123456789,
    text="Привет! Это сообщение от бота.",
    format="markdown"
)

# Получение обновлений (Long Polling)
updates = client.get_updates(timeout=30)

# Обработка обновлений
for update in updates:
    if update.type == "message_created":
        print(f"Новое сообщение от {update.message.sender.name}")
        print(f"Текст: {update.message.text}")
```

### Консольное приложение
```bash
# Запуск приложения
python -m console_app.main

# Меню:
# 1. Отправить сообщение
# 2. Слушать входящие сообщения
# 3. Информация о боте
# 4. Выход
```

---

## Дополнительные возможности (опционально)

### Фаза 2 (если есть время):
- [ ] Поддержка вложений (файлы, изображения)
- [ ] Работа с групповыми чатами
- [ ] Обработка deeplinks с payload
- [ ] Поддержка форматирования Markdown/HTML
- [ ] Логирование событий
- [ ] Конфигурация через YAML/JSON файл
- [ ] Web-интерфейс для управления ботом (Flask/FastAPI)
- [ ] Webhook сервер для production
- [ ] Асинхронная версия библиотеки (aiohttp)

---

## Требования к окружению

### Минимальные требования:
- Python 3.8+
- Доступ к интернету
- Токен бота MAX (получить на https://business.max.ru/self)

### Рекомендуемые требования:
- Python 3.10+
- Virtual environment (venv/virtualenv/conda)
- Git для версионного контроля

---

## Риски и ограничения

1. **Лимит API**: 30 запросов в секунду - необходимо реализовать rate limiting
2. **Long Polling vs Webhook**: Long Polling только для разработки, для production нужен Webhook
3. **HTTPS для Webhook**: Необходим SSL сертификат для production-окружения
4. **Токен безопасности**: Токен должен храниться безопасно, не в коде
5. **Модерация бота**: Бот должен пройти модерацию на платформе MAX

---

## Оценка времени

| Этап | Время |
|------|-------|
| 1. Подготовка и изучение API | 1 день |
| 2. Структура проекта | 0.5 дня |
| 3. Базовая библиотека | 2-3 дня |
| 4. Консольное приложение | 2 дня |
| 5. Примеры и документация | 1 день |
| 6. Тестирование | 1-2 дня |
| 7. Финализация | 0.5 дня |
| **ИТОГО** | **8-10 дней** |

---

## Следующие шаги

1. ✅ Создание структуры проекта
2. ⏳ Реализация базового клиента API
3. ⏳ Разработка моделей данных
4. ⏳ Реализация методов отправки/получения сообщений
5. ⏳ Создание консольного приложения
6. ⏳ Тестирование и документация

---

## Полезные ссылки

- [Документация MAX API](https://dev.max.ru/docs-api)
- [Подготовка чат-бота](https://dev.max.ru/docs/chatbots/bots-coding/prepare)
- [Платформа MAX для партнёров](https://business.max.ru/self)
- [Помощь и FAQ](https://dev.max.ru/help)
